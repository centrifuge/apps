name: 'onboarding-api'
on:
  release:
    types:
      - "released"
  push:
    branches:
      - main
    tags:
      - "release*"
    paths:
      - 'onboarding-api/**'
      - '.github/workflows/onboarding-api.yml'
  pull_request:
    paths:
      - 'onboarding-api/**'
      - '.github/workflows/onboarding-api.yml'
  workflow_call:
    inputs:
      deploy_demo:
        description: "Deploy to demo?"
        required: true
        type: boolean
        default: false
      deploy_prod:
        description: "Deploy to prod?"
        required: true
        type: boolean
        default: false

jobs:
  build:
    concurrency:
      group: onboarding-${{ github.ref }}
      cancel-in-progress: true    
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: onboarding-api
    steps:
      # Check out default first
      - id: checkout
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 #@v3.1.0

      - name: Setup Node
        uses: actions/setup-node@8c91899e586c5b171469028077307d293428b516 #@v3
        with:
          node-version: 16
          cache: yarn
          # cache-dependency-path: onboarding-api/yarn.lock

      - name: YARN install
        run: yarn install

      - name: Lint check
        run: yarn lint

      - name: Build function
        run: yarn build

      - name: Archive functions artifacts
        uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # @v3.1.2
        with:
          name: onboarding-api
          retention-days: 1
          path: onboarding-api/dist

  prepare_deploy:
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 #@v3.1.0

      - name: prepare env logic
        id: prepare
        uses: ./.github/actions/deployment_strategy
        with:
          app_base_name: onboarding-api
          deploy_demo: ${{ inputs.deploy_to_demo}}
    outputs:
      gh_env:  ${{ steps.prepare.outputs.gh_env }}
      app_name:  ${{ steps.prepare.outputs.app_name }}  
  
  trigger_function_deploy:
    needs: [build, prepare_deploy]
    uses: ./.github/workflows/function-deploy.yml
    secrets: inherit
    with:
      function_name: ${{ needs.prepare_deploy.outputs.app_name }}
      gh_env: ${{ needs.prepare_deploy.outputs.gh_env }}
      artifact_name: onboarding-api
    
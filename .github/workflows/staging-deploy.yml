name: Deploy Altair and staging"
on:
  release:
    types:
      - prereleased  
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/staging-deploy.yml'
jobs:
  deploy_app:
    strategy:
      fail-fast: true
      matrix:
        deploy_to: ["altair", "staging"]
    uses: centrifuge/apps/.github/workflows/centrifuge-app.yml@gh-actions-refactor
    secrets: inherit
    with:
      deploy_env: ${{ matrix.deploy_to }}


  deploy_pinning:
    strategy:
      fail-fast: true
      matrix:
        deploy_to: ["altair", "staging"]
    uses: centrifuge/apps/.github/workflows/pinning-api.yml@gh-actions-refactor
    secrets: inherit
    with:
      deploy_env: ${{ matrix.deploy_to }}


  deploy_onboarding:
    strategy:
      fail-fast: true
      matrix:
        deploy_to: ["altair", "staging"]
    uses: ./.github/workflows/onboarding-api.yml
    secrets: inherit
    with:
      deploy_env: ${{ matrix.deploy_to }}
    
    # - name: Notify prod deploy
    #   if: inputs.deploy_env == 'altair'
    #   uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7
    #   env:
    #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    #     SLACK_MESSAGE: "Main site deployed, go to ${{ needs.deploy.outputs.bucket_url  }} to check out what's new!"
    #     SLACK_USERNAME: "Centrifuge GHA Bot"
    #     SLACK_ICON: "https://centrifuge.io/favicon.ico"
    #     SLACK_TITLE: "Deployment using production credentials finished"
    #     SLACK_FOOTER: "Automatic message from centrifuge/website repository Actions"  

  archive_artifacts:
    runs-on: ubuntu-latest
    environment:  production
    strategy:
      fail-fast: true
      matrix:
        artifact_name: ["webpack", "pinning-api", "onboarding-api"]
    permissions:
      contents: write
    steps:
      - name: retrieve ${{ matrix.artifact_name }} from GH
        id: download
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # @v3.0.2
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

      - name: ZIP ${{ matrix.artifact_name }}
        shell: bash
        run: zip -r  "${{ matrix.artifact_name }}.zip"  ./${{ matrix.artifact_name }}/


      - name: upload ${{ matrix.artifact_name }} to release tag ${{ github.ref_name }}
        uses: ncipollo/release-action@a2e71bdd4e7dab70ca26a852f29600c98b33153e # @v1
        # https://github.com/ncipollo/release-action
        with:
          artifacts: "${{ matrix.artifact_name }}.zip"
          allowUpdates: true
          artifactErrorsFailBuild: true
          artifactContentType: zip
          omitBodyDuringUpdate: true
          omitDraftDuringUpdate: true
          omitNameDuringUpdate: true
          omitPrereleaseDuringUpdate: true
          updateOnlyUnreleased: true # When allowUpdates is enabled, this will fail the action if the release it is updating is not a draft or a prerelease.
          

    # Code to archive in Gcloud bucket:
      # - name: Auth gcloud
      #   id: gauth
      #   uses: google-github-actions/auth@ef5d53e30bbcd8d0836f4288f5e50ff3e086997d # @v1
      #   with:
      #     workload_identity_provider: '${{ secrets.GWIP }}'
      #     service_account: '${{ secrets.GSA }}'
      # # Install gcloud, `setup-gcloud` automatically picks up authentication from `auth`.
      # - name: 'Set up Cloud SDK'
      #   uses: 'google-github-actions/setup-gcloud@v1' 

      # - name: Archive ${{ matrix.artifact_name }} in gcloud bucket
      #   run: |
      #     echo "Archiving ${{ matrix.artifact_name }} in gs://staging-releases/${{ matrix.artifact_name }}"
      #     gsutil -m rsync -d -c -r ${{ matrix.artifact_name }}/ gs://staging-releases/${{ github.ref_name }}/${{ matrix.artifact_name }}/

  
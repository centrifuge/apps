name: 'Onboarding dev deployment'
on:
  push:
    branches:
      - onboarding/github-action-setup
      - main
    paths:
      - 'onboarding-api/**'
      - '.github/workflows/onboard-api-dev.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    defaults:
      run:
        working-directory: onboarding-api

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: yarn install

      - name: Lint
        run: yarn lint

      - name: Build
        run: yarn build

      - name: Install Firebase
        run: npm i firebase-tools -g

      - name: Prepare environment
        run: echo -e "SHUFTI_PRO_SECRET_KEY=${{ secrets.SHUFTI_PRO_SECRET_KEY }}\nSHUFTI_PRO_CLIENT_ID=${{ secrets.nSHUFTI_PRO_CLIENT_ID }}\nJWT_SECRET=${{ secrets.nJWT_SECRET }}\nNODE_ENV=development" >> .env

      - name: Deploy Functions
        run: firebase deploy --only functions --token ${{ secrets.FIREBASE_CI_TOKEN }}

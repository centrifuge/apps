name: 'Prepare env strategy'
on:
  workflow_dispatch:
    inputs:
      # git_ref:
      #   description: "branch, tag, or commit #"
      #   required: true
      #   type: string
      app_base_name:
        description: "app name you're deploying"
        required: true
        type: string
      set_env:
        description: "(Optional) Manual trigger to deploy: demo or prod"
        required: false
        type: choice
        options:
          - "production" 
          - "demo"        

jobs:
  prepare_env:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: './'
    outputs:
      app_name: ${{ steps.naming.outputs.app_name}}
      frontend_url: ${{ steps.naming.outputs.front_url }}
      gha_env:  ${{ steps.setenv.outputs.gh_env }}
    steps:
      - name: Determine Gcloud account to use
        id: setenv
        # Set Alatair and Centrifuge to deploy in the prod Gcloud account
        # both will require approval to use the GCE prod secrets
        run: |
          echo "Discover GH environment for deploy:"
          if  ${{ inputs.set_env == 'production' }}; then
            # ALTAIR & PROD
            echo "gh_env=production" >> $GITHUB_OUTPUT
          else
            # Other ENV
            echo "gh_env=preview" >> $GITHUB_OUTPUT
          fi 

      - name: Set artifact names based on environment
        id: naming
        shell: bash
        # Follow deployment strategy from 
        # https://centrifuge.hackmd.io/MFsnRldyQSa4cadx11OtVg?both#Environments
        run: |
          echo "Set app name based on env strategy"
          if  ${{ inputs.set_env == 'production' }}; then
          # Gcloud prod account
            if  ${{ github.ref == 'refs/tags/release*' }}; then
              # ALTAIR
              echo "::warning title=Deploying to prod::Replacing Altair prod function with tag ${{ github.ref }}"
              echo "app_name=${{ inputs.app_base_name }}-altair" >> $GITHUB_ENV
              echo "front_url=${{ inputs.app_base_name }}-altair.k-f.co" >> $GITHUB_ENV
            else
              # PROD
              echo "app_name=${{ inputs.app_base_name }}" >> $GITHUB_ENV
              echo "front_url=${{ inputs.app_base_name }}.k-f.co" >> $GITHUB_ENV
            fi
          elif  ${{ github.ref == 'refs/tags/rc*' }}; then
          # Gcloud dev account
            # CATALYST
            echo "app_name=${{ inputs.app_base_name }}-catalyst" >> $GITHUB_ENV
            echo "front_url=${{ inputs.app_base_name }}-catalyst.k-f.co" >> $GITHUB_ENV
          elif  ${{ github.ref == 'refs/heads/main' }}; then
            # DEV
            echo "app_name=${{ inputs.app_base_name }}-dev" >> $GITHUB_ENV
            echo "front_url=${{ inputs.app_base_name }}-dev.k-f.co" >> $GITHUB_ENV
          elif ${{ inputs.deploy_env == 'demo' }}; then
            # DEMO
            echo "app_name=${{ inputs.app_base_name }}-demo" >> $GITHUB_ENV
            echo "front_url=${{ inputs.app_base_name }}-demo.k-f.co" >> $GITHUB_ENV
          else
            # PR
            echo "app_name=${{ inputs.app_base_name }}-pr${{ github.event.number }}" >> $GITHUB_ENV
            echo "front_url=${{ inputs.app_base_name }}-pr${{ github.event.number }}.k-f.co" >> $GITHUB_ENV
          fi
          echo "Environment stage is set:"
          echo "${{ env.app_name }}"      
